<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMC Institutional Dashboard</title>

<style>
:root{
    --bg:#0f172a;
    --card:#1e293b;
    --border:#334155;
    --text:#e2e8f0;
    --dim:#94a3b8;
    --green:#22c55e;
    --red:#ef4444;
    --yellow:#facc15;
}

*{box-sizing:border-box}

body{
    margin:0;
    font-family:Segoe UI,Roboto,Arial;
    background:var(--bg);
    color:var(--text);
}

.top-bar{
    background:var(--card);
    padding:15px 40px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid var(--border);
}

.logo{
    font-weight:800;
    font-size:18px;
}

.selector{
    display:flex;
    gap:20px;
}

select{
    background:var(--bg);
    color:var(--text);
    border:1px solid var(--border);
    padding:6px 12px;
    border-radius:6px;
}

.signal-box{
    margin:20px auto;
    width:90%;
    max-width:1200px;
    padding:16px;
    border-radius:10px;
    text-align:center;
    font-weight:700;
    border:1px solid var(--border);
    background:var(--card);
}

.container{
    width:95%;
    max-width:1400px;
    margin:auto;
    display:grid;
    grid-template-columns:280px 1fr;
    gap:20px;
}

.side{
    display:flex;
    flex-direction:column;
    gap:15px;
}

.card{
    background:var(--card);
    padding:18px;
    border-radius:10px;
    border:1px solid var(--border);
}

.card h4{
    margin:0 0 8px 0;
    font-size:12px;
    color:var(--dim);
    text-transform:uppercase;
}

.value{
    font-size:22px;
    font-weight:700;
}

.conf-bar{
    height:4px;
    background:var(--border);
    border-radius:2px;
    margin-top:8px;
}

.conf-fill{
    height:100%;
    width:0%;
    border-radius:2px;
    background:var(--green);
}

.chart{
    background:var(--card);
    border-radius:10px;
    border:1px solid var(--border);
    overflow:hidden;
}

.chart-header{
    padding:10px 15px;
    font-size:13px;
    color:var(--dim);
    border-bottom:1px solid var(--border);
}

#main_chart{height:600px}

@media(max-width:900px){
    .container{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="logo">SMC LIVE • INSTITUTIONAL ENGINE</div>
    <div class="selector">
        <select id="symbol">
            <option>XAUUSD</option>
            <option>EURUSD</option>
            <option>XAGUSD</option>
            <option>BTCUSD</option>
        </select>
        <select id="tf">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m" selected>15m</option>
            <option value="30m">30m</option>
            <option value="1h">1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
        </select>
    </div>
</div>

<div id="signalBox" class="signal-box">
    INITIALIZING...
</div>

<div class="container">

<div class="side">

<div class="card">
<h4>Live Price</h4>
<div id="price" class="value">--</div>
</div>

<div class="card">
<h4>Market Structure</h4>
<div id="structure">--</div>
</div>

<div class="card">
<h4>Confidence</h4>
<div id="confidence" class="value">0%</div>
<div class="conf-bar">
<div id="confFill" class="conf-fill"></div>
</div>
</div>

<div class="card">
<h4>Trade Levels</h4>
<div id="levels" style="font-size:13px"></div>
</div>

</div>

<div class="chart">
<div class="chart-header" id="chartTitle">
Loading chart...
</div>
<div id="main_chart"></div>
</div>

</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>

const API = "http://127.0.0.1:8000/api/signal/";

let widget = null;
let lastPrice = null;

const tvSymbol = {
    XAUUSD:"OANDA:XAUUSD",
    EURUSD:"FX:EURUSD",
    XAGUSD:"OANDA:XAGUSD",
    BTCUSD:"COINBASE:BTCUSD"
};

function loadChart(symbol, tf){
    if(widget){
        try{widget.remove()}catch{}
        document.getElementById("main_chart").innerHTML="";
    }

    widget = new TradingView.widget({
        symbol:tvSymbol[symbol],
        interval:tf.replace("m","").replace("h","60").replace("d","D"),
        timezone:"Asia/Dhaka",
        theme:"dark",
        style:"1",
        container_id:"main_chart"
    });

    document.getElementById("chartTitle").innerText =
        symbol + " • " + tf + " • Smart Money Concepts";
}

function formatStructure(str){
    if(!str) return "--";
    return str.split("|").map(s=>{
        s=s.trim();
        if(s.includes("bullish")) return `<span style="color:#22c55e">${s}</span>`;
        if(s.includes("bearish")) return `<span style="color:#ef4444">${s}</span>`;
        return s;
    }).join("<br>");
}

function updateSignal(data,symbol){

    const box=document.getElementById("signalBox");
    const conf=parseInt(data.confidence||0);

    if(data.signal.includes("LONG")){
        box.style.background="#052e1c";
        box.style.color="#22c55e";
        box.innerHTML="▲ BULLISH BIAS • "+data.signal;
    }
    else if(data.signal.includes("SHORT")){
        box.style.background="#3b0a0a";
        box.style.color="#ef4444";
        box.innerHTML="▼ BEARISH BIAS • "+data.signal;
    }
    else{
        box.style.background="#1e293b";
        box.style.color="#94a3b8";
        box.innerHTML="NO CLEAR TRADE";
    }

    document.getElementById("structure").innerHTML =
        formatStructure(data.structure);

    document.getElementById("confidence").innerText=conf+"%";

    const fill=document.getElementById("confFill");
    fill.style.width=conf+"%";
    fill.style.background =
        conf>=80?"#22c55e":
        conf>=60?"#facc15":
        "#ef4444";

    document.getElementById("levels").innerHTML=`
        Entry: ${data.entry_price}<br>
        SL: ${data.stop_loss}<br>
        TP1: ${data.take_profit_1}<br>
        TP2: ${data.take_profit_2}<br>
        TP3: ${data.take_profit_3}
    `;
}

async function update(){

    const symbol=document.getElementById("symbol").value;
    const tf=document.getElementById("tf").value;

    loadChart(symbol,tf);

    try{
        const res=await fetch(API+`?symbol=${symbol}&tf=${tf}`);
        const data=await res.json();

        updateSignal(data,symbol);

        if(data.entry_price){
            const p=parseFloat(data.entry_price);
            document.getElementById("price").innerText=p.toFixed(2);
            lastPrice=p;
        }
    }
    catch{
        console.log("API error");
    }
}

document.getElementById("symbol").onchange=update;
document.getElementById("tf").onchange=update;

setInterval(update,5000);
update();

</script>
</body>
</html>