<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMC Institutional ‚Ä¢ 3‚ÄëLayer Engine</title>

<style>
:root{
    --bg:#0f172a;
    --card:#1e293b;
    --border:#334155;
    --text:#e2e8f0;
    --dim:#94a3b8;
    --green:#22c55e;
    --red:#ef4444;
    --yellow:#facc15;
    --blue:#3b82f6;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
    font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
    background:var(--bg);
    color:var(--text);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
}

.top-bar{
    background:var(--card);
    padding:15px 40px;
    width:100%;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid var(--border);
    flex-wrap:wrap;
    gap:15px;
}

.logo{
    font-weight:800;
    font-size:1.3rem;
    background:linear-gradient(135deg, #fff, #94a3b8);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}

.selector{
    display:flex;
    gap:20px;
}

select{
    background:var(--bg);
    color:var(--text);
    border:1px solid var(--border);
    padding:8px 16px;
    border-radius:8px;
    font-size:0.95rem;
    cursor:pointer;
    outline:none;
}
select:hover{border-color:var(--blue);}

.container{
    width:95%;
    max-width:1400px;
    margin:25px auto;
    display:grid;
    grid-template-columns:320px 1fr;
    gap:25px;
}

.side{
    display:flex;
    flex-direction:column;
    gap:18px;
}

.card{
    background:var(--card);
    padding:18px;
    border-radius:14px;
    border:1px solid var(--border);
    transition:0.2s;
}
.card:hover{border-color:#4b5a75;}

.card h4{
    margin:0 0 12px 0;
    font-size:0.8rem;
    font-weight:600;
    letter-spacing:0.5px;
    color:var(--dim);
    text-transform:uppercase;
    display:flex;
    align-items:center;
    gap:6px;
}
.card h4 i{font-size:1rem;}

.signal{
    font-weight:700;
    font-size:1.2rem;
    margin-bottom:12px;
}

.levels{
    font-size:0.85rem;
    line-height:1.8;
    color:var(--dim);
    background:#0f172a50;
    padding:10px;
    border-radius:8px;
}
.levels span{color:var(--text);font-weight:500;}

.meta{
    margin-top:12px;
    font-size:0.75rem;
    display:flex;
    justify-content:space-between;
    color:var(--dim);
}

.chart{
    background:var(--card);
    border-radius:14px;
    border:1px solid var(--border);
    overflow:hidden;
}

.chart-header{
    padding:14px 18px;
    font-size:0.9rem;
    font-weight:500;
    color:var(--dim);
    border-bottom:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:center;
}

#main_chart{height:600px;}

.alignment{
    text-align:center;
    font-weight:700;
    padding:14px;
    border-radius:40px;
    margin-bottom:5px;
    background:#1e2a3a;
    border:1px solid var(--border);
    font-size:0.95rem;
    letter-spacing:0.5px;
}

.sweep-badge{
    display:inline-block;
    background:#2d3a4f;
    padding:2px 10px;
    border-radius:20px;
    font-size:0.7rem;
    color:var(--dim);
    margin-left:8px;
}

.footer-note{
    margin-top:10px;
    font-size:0.7rem;
    color:var(--dim);
    text-align:center;
    width:100%;
}
</style>
</head>

<body>

<div class="top-bar">
    <div class="logo">‚ö° SMC ¬∑ 3‚ÄëLAYER INSTITUTIONAL ENGINE</div>
    <div class="selector">
        <select id="symbol">
            <option value="XAUUSD" selected>XAUUSD (Gold)</option>
            <option value="EURUSD">EURUSD (Euro)</option>
            <option value="XAGUSD">XAGUSD (Silver)</option>
            <option value="BTCUSD">BTCUSD (Bitcoin)</option>
        </select>
        <select id="tf">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m" selected>15m</option>
            <option value="30m">30m</option>
            <option value="1h">1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
        </select>
    </div>
</div>

<div class="container">

<div class="side">

<div id="alignmentBox" class="alignment">
    üîÑ Alignment: Checking...
</div>

<div class="card">
    <h4><span style="color:#facc15">‚ö°</span> SCALP MODE ¬∑ LTF DRIVEN</h4>
    <div id="scalp">
        <div class="signal" style="color:var(--dim)">‚Äî</div>
        <div class="levels">Waiting for signal‚Ä¶</div>
    </div>
</div>

<div class="card">
    <h4><span style="color:#3b82f6">üè¶</span> INSTITUTIONAL ¬∑ HTF DOMINANT</h4>
    <div id="institutional">
        <div class="signal" style="color:var(--dim)">‚Äî</div>
        <div class="levels">Waiting for signal‚Ä¶</div>
    </div>
</div>

<div class="card">
    <h4><span style="color:#22c55e">üîÑ</span> HYBRID ¬∑ FULL ALIGNMENT</h4>
    <div id="hybrid">
        <div class="signal" style="color:var(--dim)">‚Äî</div>
        <div class="levels">Waiting for signal‚Ä¶</div>
    </div>
</div>

<div class="card" style="padding:12px 18px">
    <div style="display:flex; justify-content:space-between; font-size:0.8rem">
        <span>üìä Live price</span>
        <span id="livePrice">--</span>
    </div>
    <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-top:6px">
        <span>‚è±Ô∏è Refresh in</span>
        <span id="timer">5s</span>
    </div>
</div>

</div>

<div class="chart">
    <div class="chart-header" id="chartTitle">
        <span>üìà Smart Money ¬∑ order flow</span>
        <span id="apiStatus" style="font-size:0.7rem; background:#1e2a3a; padding:4px 12px; border-radius:40px;">‚ö° live</span>
    </div>
    <div id="main_chart"></div>
</div>

</div>

<div class="footer-note">
    SMC 3‚Äëlayer engine ¬∑ scalp ¬∑ institutional ¬∑ hybrid
</div>

<script src="https://s3.tradingview.com/tv.js"></script>

<script>
// ==================== CONFIG ====================
const API_URL = "http://127.0.0.1:8000/api/signal/";
let tvWidget = null;
let timeLeft = 5;

// TradingView symbol mapping
const TV_SYMBOL = {
    XAUUSD: "OANDA:XAUUSD",
    EURUSD: "FX:EURUSD",
    XAGUSD: "OANDA:XAGUSD",
    BTCUSD: "COINBASE:BTCUSD"
};

// ==================== HELPER FUNCTIONS ====================
function formatPrice(price) {
    return price?.toFixed?.(2) ?? (price ? Number(price).toFixed(2) : '--');
}

function renderSignalCard(data, elementId) {
    const el = document.getElementById(elementId);
    if (!el) return;

    if (!data || data.signal === "NO_TRADE" || data.signal?.includes("NO_TRADE")) {
        el.innerHTML = `
            <div class="signal" style="color:var(--dim)">‚è≥ NO TRADE</div>
            <div class="levels">Structure: ${data?.structure || 'neutral'}<br>Confidence: ${data?.confidence || 0}%</div>
        `;
        return;
    }

    const isLong = data.direction === "LONG";
    const color = isLong ? "var(--green)" : "var(--red)";
    const arrow = isLong ? "‚ñ≤" : "‚ñº";

    let sweepHtml = data.liquidity_swept ? '<span class="sweep-badge">üíß sweep</span>' : '';

    el.innerHTML = `
        <div class="signal" style="color:${color}">
            ${arrow} ${data.signal} (${data.confidence}%) ${sweepHtml}
        </div>
        <div class="levels">
            <span>Entry:</span> ${formatPrice(data.entry_price)}<br>
            <span>Stop loss:</span> ${formatPrice(data.stop_loss)}<br>
            <span>TP1 (1:2):</span> ${formatPrice(data.take_profit_1)}<br>
            <span>TP2 (1:3):</span> ${formatPrice(data.take_profit_2)}<br>
            <span>TP3 (1:5):</span> ${formatPrice(data.take_profit_3)}
        </div>
        <div class="meta">
            <span>${data.structure || '‚Äî'}</span>
            <span>‚ö° ${data.confidence || 0}%</span>
        </div>
    `;
}

function updateAlignment(data) {
    const box = document.getElementById("alignmentBox");
    if (!box) return;

    const scalpDir = data.scalp?.direction;
    const instDir = data.institutional?.direction;
    const hybridDir = data.hybrid?.direction;

    // FULL ALIGNMENT : all three same and not NO_TRADE
    if (scalpDir && instDir && hybridDir &&
        scalpDir === instDir && instDir === hybridDir &&
        scalpDir !== "NO_TRADE" && scalpDir !== "NEUTRAL") {
        box.style.background = "#064e3b";
        box.style.color = "#4ade80";
        box.style.borderColor = "#4ade80";
        box.innerHTML = `‚úÖ FULL ALIGNMENT ¬∑ ${scalpDir}`;
        return;
    }

    // HYBRID gives direction (usually strongest)
    if (hybridDir && hybridDir !== "NO_TRADE" && hybridDir !== "NEUTRAL") {
        box.style.background = "#1e293b";
        box.style.color = "#facc15";
        box.style.borderColor = "#facc15";
        box.innerHTML = `‚ö†Ô∏è PARTIAL ¬∑ Hybrid: ${hybridDir}`;
        return;
    }

    // default
    box.style.background = "#1e293b";
    box.style.color = "#94a3b8";
    box.style.borderColor = "#334155";
    box.innerHTML = `‚ö™ NO ALIGNMENT ¬∑ analyzing`;
}

function loadChart(symbol, tf) {
    if (tvWidget) {
        try { tvWidget.remove(); } catch { }
        document.getElementById("main_chart").innerHTML = "";
    }

    // convert django timeframe to TradingView interval
    const intervalMap = {
        '1m': '1', '5m': '5', '15m': '15', '30m': '30',
        '1h': '60', '4h': '240', '1d': 'D'
    };

    tvWidget = new TradingView.widget({
        width: "100%",
        height: "100%",
        symbol: TV_SYMBOL[symbol],
        interval: intervalMap[tf] || '15',
        timezone: "Asia/Dhaka",
        theme: "dark",
        style: "1",
        container_id: "main_chart",
        locale: "en",
        toolbar_bg: "#0f172a",
        enable_publishing: false,
        hide_side_toolbar: false,
        studies: ["MACD@tv-basicstudies", "RSI@tv-basicstudies"]
    });

    document.getElementById("chartTitle").innerHTML = `
        <span>üìà ${symbol} ¬∑ ${tf} ¬∑ Smart Money Concepts</span>
        <span id="apiStatus" style="font-size:0.7rem; background:#1e2a3a; padding:4px 12px; border-radius:40px;">‚ö° live</span>
    `;
}

// ==================== MAIN FETCH ====================
async function fetchSignals() {
    const symbol = document.getElementById("symbol").value;
    const tf = document.getElementById("tf").value;

    try {
        const url = `${API_URL}?symbol=${symbol}&tf=${tf}`;
        console.log("Fetching:", url);
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        // display live price if available
        if (data.hybrid?.entry_price) {
            document.getElementById("livePrice").innerText = formatPrice(data.hybrid.entry_price);
        }

        // render cards
        renderSignalCard(data.scalp, "scalp");
        renderSignalCard(data.institutional, "institutional");
        renderSignalCard(data.hybrid, "hybrid");

        // alignment box
        updateAlignment(data);

        document.getElementById("apiStatus").innerText = "‚úì live";
    } catch (err) {
        console.error("API error", err);
        document.getElementById("apiStatus").innerText = "‚ö†Ô∏è offline";

        // fallback ‚Äì keep previous data
    }
}

// ==================== DASHBOARD UPDATE ====================
function updateDashboard() {
    const symbol = document.getElementById("symbol").value;
    const tf = document.getElementById("tf").value;

    loadChart(symbol, tf);
    fetchSignals();

    timeLeft = 5;
    document.getElementById("timer").innerText = timeLeft + "s";
}

// ==================== TIMER ====================
setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
        fetchSignals();      // only refresh data, keep chart
        timeLeft = 5;
    }
    document.getElementById("timer").innerText = timeLeft + "s";
}, 1000);

// ==================== EVENT LISTENERS ====================
document.getElementById("symbol").addEventListener("change", updateDashboard);
document.getElementById("tf").addEventListener("change", updateDashboard);

// ==================== START ====================
updateDashboard();

</script>

</body>
</html>